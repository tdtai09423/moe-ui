variables:
  NPM_CONFIG_YES: "true"
  CI: "false"
  GITHUB_REPO: "git@github.com:tdtai09423/moe-ui.git"

stages:
  - build
  - sync_to_github

default:
  tags:
    - moe-kain

# ==================== BUILD STAGES ====================
.build_template: &build_definition
  stage: build
  script:
    - cd $UI_DIR
    - npm install
    - npm run build
  artifacts:
    paths:
      - $UI_DIR/dist/
    expire_in: 1 hour
  only:
    - main

build_admin_ui:
  <<: *build_definition
  variables:
    UI_DIR: "moe_admin_ui"

build_student_ui:
  <<: *build_definition
  variables:
    UI_DIR: "moe_student_ui"

# ==================== PUSH TO GITHUB ====================
sync_to_github:
  stage: sync_to_github
  variables:
    # Không cần khai báo lại SSH_PRIVATE_KEY ở đây, nó sẽ lấy từ GitLab Settings
    GIT_STRATEGY: clone
  script:
    - Write-Host "Configuring SSH for GitHub..."
    
    # Tạo thư mục .ssh nếu chưa có (Dành cho Windows Runner)
    - if (-not (Test-Path "$env:USERPROFILE\.ssh")) { New-Item -Path "$env:USERPROFILE\.ssh" -ItemType Directory }
    
    # Copy file SSH Key từ biến GitLab (giả sử bạn đặt tên biến là SSH_PRIVATE_KEY)
    - Copy-Item "$env:SSH_PRIVATE_KEY" -Destination "$env:USERPROFILE\.ssh\id_ed25519"
    
    # Cấu hình known_hosts để không bị hỏi xác nhận lần đầu
    - ssh-keyscan github.com | Out-File -FilePath "$env:USERPROFILE\.ssh\known_hosts" -Encoding ascii
    
    - Write-Host "Syncing to GitHub..."
    # Cấu hình Git Identity
    - git config user.email "gitlab-runner@moe.com"
    - git config user.name "GitLab Runner Sync"
    
    # Xử lý Remote và Push
    - if (git remote | Select-String "github") { git remote remove github }
    - git remote add github $env:GITHUB_REPO
    
    # Đẩy nhánh main lên GitHub (Dùng -f nếu bạn muốn ghi đè hoàn toàn GitHub bằng GitLab)
    - git push github main -f
    - Write-Host "Successfully pushed to GitHub!"
  only:
    - main