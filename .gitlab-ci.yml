variables:
  NPM_CONFIG_YES: "true"
  CI: "false"

stages:
  - build
  - deploy

default:
  tags:
    - moe-kain

# ==================== BUILD FE ADMIN ====================
build_admin_ui:
  stage: build
  script:
    - Write-Host "=========================================="
    - Write-Host "Building Admin UI..."
    - Write-Host "=========================================="
    - cd moe_admin_ui
    - Write-Host "Installing dependencies..."
    - npm install
    - Write-Host "Building project..."
    - npm run build
    - Write-Host "Build completed successfully!"
    - Write-Host "Checking build output..."
    - if (Test-Path "./dist") { Write-Host "dist folder exists"; Get-ChildItem ./dist -Recurse | Select-Object -First 5 } else { Write-Error "dist folder not found!"; exit 1 }
  artifacts:
    paths:
      - moe_admin_ui/dist/
    expire_in: 1 hour
  only:
    - main

# ==================== BUILD FE STUDENT ====================
build_student_ui:
  stage: build
  script:
    - Write-Host "=========================================="
    - Write-Host "Building Student UI..."
    - Write-Host "=========================================="
    - cd moe_student_ui
    - Write-Host "Installing dependencies..."
    - npm install
    - Write-Host "Building project..."
    - npm run build
    - Write-Host "Build completed successfully!"
    - Write-Host "Checking build output..."
    - if (Test-Path "./dist") { Write-Host "dist folder exists"; Get-ChildItem ./dist -Recurse | Select-Object -First 5 } else { Write-Error "dist folder not found!"; exit 1 }
  artifacts:
    paths:
      - moe_student_ui/dist/
    expire_in: 1 hour
  only:
    - main

# ==================== DEPLOY FE ADMIN TO AZURE SWA ====================
deploy_fe_admin:
  stage: deploy
  dependencies:
    - build_admin_ui
  script:
    - Write-Host "=========================================="
    - Write-Host "Deploying Admin UI to Azure Static Web App..."
    - Write-Host "=========================================="
    
    # Verify deployment token
    - |
      if ([string]::IsNullOrEmpty($env:AZURE_SWA_ADMIN_TOKEN)) {
        Write-Error "AZURE_SWA_ADMIN_TOKEN is not set!"
        exit 1
      } else {
        Write-Host "Deployment token verified"
      }
    
    # Verify build artifacts
    - Write-Host "Verifying build artifacts..."
    - |
      if (Test-Path "./moe_admin_ui/dist") { 
        Write-Host "Build artifacts found"
        $fileCount = (Get-ChildItem ./moe_admin_ui/dist -Recurse -File).Count
        Write-Host "Total files to deploy: $fileCount"
        Get-ChildItem ./moe_admin_ui/dist -Recurse | Select-Object -First 5
      } else { 
        Write-Error "Build folder not found!"
        exit 1
      }
    
    # Deploy using direct API upload
    - Write-Host "Starting deployment via Azure API..."
    - |
      $distPath = "./moe_admin_ui/dist"
      $token = $env:AZURE_SWA_ADMIN_TOKEN
      
      # Create deployment zip
      Write-Host "Creating deployment package..."
      $zipPath = "deploy_admin.zip"
      Compress-Archive -Path "$distPath/*" -DestinationPath $zipPath -Force
      Write-Host "Deployment package created: $((Get-Item $zipPath).Length / 1MB) MB"
      
      # Upload to Azure Static Web Apps
      Write-Host "Uploading to Azure Static Web Apps..."
      $deployUrl = "https://api.azurestaticapps.net/api/v1/deploy"
      
      $headers = @{
        "Authorization" = "Bearer $token"
        "Content-Type" = "application/zip"
      }
      
      try {
        $response = Invoke-RestMethod -Uri $deployUrl -Method Post -Headers $headers -InFile $zipPath -TimeoutSec 300
        Write-Host "Deployment successful!"
        Write-Host "Response: $($response | ConvertTo-Json -Depth 2)"
      } catch {
        Write-Error "Deployment failed: $_"
        if ($_.Exception.Response) {
          $reader = New-Object System.IO.StreamReader($_.Exception.Response.GetResponseStream())
          $responseBody = $reader.ReadToEnd()
          Write-Error "Response: $responseBody"
        }
        exit 1
      }
    
    - Write-Host "Deployment completed successfully!"
  when: manual
  only:
    - main

# ==================== DEPLOY FE STUDENT TO AZURE SWA ====================
deploy_fe_student:
  stage: deploy
  dependencies:
    - build_student_ui
  script:
    - Write-Host "=========================================="
    - Write-Host "Deploying Student UI to Azure Static Web App..."
    - Write-Host "=========================================="
    
    # Verify deployment token
    - |
      if ([string]::IsNullOrEmpty($env:AZURE_SWA_STUDENT_TOKEN)) {
        Write-Error "AZURE_SWA_STUDENT_TOKEN is not set!"
        exit 1
      } else {
        Write-Host "Deployment token verified"
      }
    
    # Verify build artifacts
    - Write-Host "Verifying build artifacts..."
    - |
      if (Test-Path "./moe_student_ui/dist") { 
        Write-Host "Build artifacts found"
        $fileCount = (Get-ChildItem ./moe_student_ui/dist -Recurse -File).Count
        Write-Host "Total files to deploy: $fileCount"
        Get-ChildItem ./moe_student_ui/dist -Recurse | Select-Object -First 5
      } else { 
        Write-Error "Build folder not found!"
        exit 1
      }
    
    # Deploy using direct API upload
    - Write-Host "Starting deployment via Azure API..."
    - |
      $distPath = "./moe_student_ui/dist"
      $token = $env:AZURE_SWA_STUDENT_TOKEN
      
      # Create deployment zip
      Write-Host "Creating deployment package..."
      $zipPath = "deploy_student.zip"
      Compress-Archive -Path "$distPath/*" -DestinationPath $zipPath -Force
      Write-Host "Deployment package created: $((Get-Item $zipPath).Length / 1MB) MB"
      
      # Upload to Azure Static Web Apps
      Write-Host "Uploading to Azure Static Web Apps..."
      $deployUrl = "https://api.azurestaticapps.net/api/v1/deploy"
      
      $headers = @{
        "Authorization" = "Bearer $token"
        "Content-Type" = "application/zip"
      }
      
      try {
        $response = Invoke-RestMethod -Uri $deployUrl -Method Post -Headers $headers -InFile $zipPath -TimeoutSec 300
        Write-Host "Deployment successful!"
        Write-Host "Response: $($response | ConvertTo-Json -Depth 2)"
      } catch {
        Write-Error "Deployment failed: $_"
        if ($_.Exception.Response) {
          $reader = New-Object System.IO.StreamReader($_.Exception.Response.GetResponseStream())
          $responseBody = $reader.ReadToEnd()
          Write-Error "Response: $responseBody"
        }
        exit 1
      }
    
    - Write-Host "Deployment completed successfully!"
  when: manual
  only:
    - main