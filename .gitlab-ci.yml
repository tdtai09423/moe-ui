variables:
  NPM_CONFIG_YES: "true"
  CI: "false"
  GITHUB_REPO: "git@github.com:tdtai09423/moe-ui.git"

stages:
  - build
  - sync_to_github

default:
  tags:
    - moe-kain

# ==================== BUILD STAGES ====================
.build_template: &build_definition
  stage: build
  script:
    - cd $UI_DIR
    - npm install
    - npm run build
  artifacts:
    paths:
      - $UI_DIR/dist/
    expire_in: 1 hour
  only:
    - main

build_admin_ui:
  <<: *build_definition
  variables:
    UI_DIR: "moe_admin_ui"

build_student_ui:
  <<: *build_definition
  variables:
    UI_DIR: "moe_student_ui"

# ==================== PUSH TO GITHUB ====================
sync_to_github:
  stage: sync_to_github
  dependencies:
    - build_admin_ui
    - build_student_ui
  variables:
    GIT_STRATEGY: clone
    GITHUB_REPO_HTTPS: "github.com/tdtai09423/moe-ui.git"
  script:
    - |
      $ErrorActionPreference = "Stop"

      Write-Host "--- 1. Configuring Git Identity ---"
      git config user.email "gitlab-runner@moe.com"
      git config user.name "GitLab Runner Sync"

      Write-Host "--- 2. Preparing Repository ---"
      # Đảm bảo chúng ta đang ở nhánh main và có dữ liệu
      git checkout -B main
      
      # Thêm các thay đổi nếu có (ví dụ các folder dist nếu bạn muốn push cả nó)
      # git add .
      # git commit -m "Sync from GitLab: $CI_COMMIT_SHA" || Write-Host "No changes to commit"

      Write-Host "--- 3. Configuring Remote with Token ---"
      if (git remote | Select-String "github") { git remote remove github }
      
      # ĐỊNH DẠNG CHUẨN: https://username:token@github.com/...
      # Thay 'tdtai09423' bằng đúng username GitHub của bạn
      $remoteUrl = "https://tdtai09423:${env:GITHUB_TOKEN}@${env:GITHUB_REPO_HTTPS}"
      git remote add github $remoteUrl

      Write-Host "--- 4. Pushing to GitHub ---"
      # Thêm --set-upstream và force push
      git push github main --force
      
      if ($LASTEXITCODE -ne 0) {
          Write-Error "Git push failed. Hãy kiểm tra: 1. Token có quyền 'repo' không? 2. Username 'tdtai09423' có đúng không?"
          exit 1
      } else {
          Write-Host "Successfully pushed to GitHub!"
      }
  only:
    - main