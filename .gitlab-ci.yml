variables:
  NPM_CONFIG_YES: "true"
  CI: "false"
  GITHUB_REPO: "git@github.com:tdtai09423/moe-ui.git"

stages:
  - build
  - sync_to_github

default:
  tags:
    - moe-kain

# ==================== BUILD STAGES ====================
.build_template: &build_definition
  stage: build
  script:
    - cd $UI_DIR
    - npm install
    - npm run build
  artifacts:
    paths:
      - $UI_DIR/dist/
    expire_in: 1 hour
  only:
    - main

build_admin_ui:
  <<: *build_definition
  variables:
    UI_DIR: "moe_admin_ui"

build_student_ui:
  <<: *build_definition
  variables:
    UI_DIR: "moe_student_ui"

# ==================== PUSH TO GITHUB ====================
sync_to_github:
  stage: sync_to_github
  dependencies:
    - build_admin_ui
    - build_student_ui
  variables:
    GIT_STRATEGY: clone
    GIT_DEPTH: "0" # Lấy toàn bộ lịch sử để không bị lỗi unpack
  script:
    - |
      $ErrorActionPreference = "Stop"
      
      Write-Host "--- 1. Resetting Environment ---"
      # Xóa sạch cấu hình cũ để tránh xung đột trên Windows VM
      git config --global credential.helper ""
      git config --global core.ignorecase true
      git config user.email "gitlab-runner@moe.com"
      git config user.name "GitLab Runner Sync"

      Write-Host "--- 2. Preparing Branch ---"
      git checkout -B main

      Write-Host "--- 3. Pushing to GitHub (Direct URL) ---"
      # Đẩy trực tiếp bằng URL, không qua remote add để tránh lỗi cache ref
      $githubUrl = "https://x-access-token:${env:GITHUB_TOKEN}@github.com/tdtai09423/moe-ui.git"
      
      # Thêm --atomic và -v để xem chi tiết nếu lỗi
      git push $githubUrl main:main --force --atomic -v
      
      Write-Host "Successfully synced to GitHub!"
  only:
    - main