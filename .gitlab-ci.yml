variables:
  NPM_CONFIG_YES: "true"
  CI: "false"

stages:
  - build
  - deploy

default:
  tags:
    - moe-kain

# ==================== BUILD FE ADMIN ====================
build_admin_ui:
  stage: build
  script:
    - Write-Host "=========================================="
    - Write-Host "Building Admin UI..."
    - Write-Host "=========================================="
    - cd moe_admin_ui
    - Write-Host "Installing dependencies..."
    - npm install
    - Write-Host "Building project..."
    - npm run build
    - Write-Host "Build completed successfully!"
    - Write-Host "Checking build output..."
    - if (Test-Path "./dist") { Write-Host "dist folder exists"; Get-ChildItem ./dist -Recurse | Select-Object -First 5 } else { Write-Error "dist folder not found!"; exit 1 }
  artifacts:
    paths:
      - moe_admin_ui/dist/
    expire_in: 1 hour
  only:
    - main

# ==================== BUILD FE STUDENT ====================
build_student_ui:
  stage: build
  script:
    - Write-Host "=========================================="
    - Write-Host "Building Student UI..."
    - Write-Host "=========================================="
    - cd moe_student_ui
    - Write-Host "Installing dependencies..."
    - npm install
    - Write-Host "Building project..."
    - npm run build
    - Write-Host "Build completed successfully!"
    - Write-Host "Checking build output..."
    - if (Test-Path "./dist") { Write-Host "dist folder exists"; Get-ChildItem ./dist -Recurse | Select-Object -First 5 } else { Write-Error "dist folder not found!"; exit 1 }
  artifacts:
    paths:
      - moe_student_ui/dist/
    expire_in: 1 hour
  only:
    - main

# ==================== DEPLOY FE ADMIN TO AZURE SWA ====================
deploy_fe_admin:
  stage: deploy
  dependencies:
    - build_admin_ui
  script:
    - Write-Host "=========================================="
    - Write-Host "Deploying Admin UI to Azure Static Web App..."
    - Write-Host "=========================================="
    
    # Check and install SWA CLI if needed
    - Write-Host "Checking for SWA CLI..."
    - |
      try {
        $null = Get-Command swa -ErrorAction Stop
        Write-Host "SWA CLI is already installed"
      } catch {
        Write-Host "SWA CLI not found. Installing globally..."
        npm install -g @azure/static-web-apps-cli
        Write-Host "SWA CLI installed successfully"
      }
    
    # Verify deployment token
    - |
      if ([string]::IsNullOrEmpty($env:AZURE_SWA_ADMIN_TOKEN)) {
        Write-Error "AZURE_SWA_ADMIN_TOKEN is not set!"
        exit 1
      } else {
        Write-Host "Deployment token verified"
      }
    
    # Verify build artifacts
    - Write-Host "Verifying build artifacts..."
    - |
      if (Test-Path "./moe_admin_ui/dist") { 
        Write-Host "Build artifacts found"
        Get-ChildItem ./moe_admin_ui/dist -Recurse | Select-Object -First 5
      } else { 
        Write-Error "Build folder not found!"
        exit 1
      }
    
    # Deploy to Azure Static Web Apps
    - Write-Host "Starting deployment..."
    - npx @azure/static-web-apps-cli deploy ./moe_admin_ui/dist --deployment-token $env:AZURE_SWA_ADMIN_TOKEN --env production
    - Write-Host "Deployment completed successfully!"
  when: manual
  only:
    - main

# ==================== DEPLOY FE STUDENT TO AZURE SWA ====================
deploy_fe_student:
  stage: deploy
  dependencies:
    - build_student_ui
  script:
    - Write-Host "=========================================="
    - Write-Host "Deploying Student UI to Azure Static Web App..."
    - Write-Host "=========================================="
    
    # Check and install SWA CLI if needed
    - Write-Host "Checking for SWA CLI..."
    - |
      try {
        $null = Get-Command swa -ErrorAction Stop
        Write-Host "SWA CLI is already installed"
      } catch {
        Write-Host "SWA CLI not found. Installing globally..."
        npm install -g @azure/static-web-apps-cli
        Write-Host "SWA CLI installed successfully"
      }
    
    # Verify deployment token
    - |
      if ([string]::IsNullOrEmpty($env:AZURE_SWA_STUDENT_TOKEN)) {
        Write-Error "AZURE_SWA_STUDENT_TOKEN is not set!"
        exit 1
      } else {
        Write-Host "Deployment token verified"
      }
    
    # Verify build artifacts
    - Write-Host "Verifying build artifacts..."
    - |
      if (Test-Path "./moe_student_ui/dist") { 
        Write-Host "Build artifacts found"
        Get-ChildItem ./moe_student_ui/dist -Recurse | Select-Object -First 5
      } else { 
        Write-Error "Build folder not found!"
        exit 1
      }
    
    # Deploy to Azure Static Web Apps
    - Write-Host "Starting deployment..."
    - npx @azure/static-web-apps-cli deploy ./moe_student_ui/dist --deployment-token $env:AZURE_SWA_STUDENT_TOKEN --env production
    - Write-Host "Deployment completed successfully!"
  when: manual
  only:
    - main